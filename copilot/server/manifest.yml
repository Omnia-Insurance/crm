# Server Service Manifest
# Handles HTTP requests and runs database migrations on startup

name: server
type: Load Balanced Web Service

image:
  location: twentycrm/twenty:latest
  port: 3000

http:
  path: '/'
  healthcheck:
    path: '/healthz'
    success_codes: '200'
    interval: 30s
    timeout: 10s
    retries: 3
    grace_period: 120s  # Allow time for migrations

cpu: 512       # 0.5 vCPU
memory: 1024   # 1 GB
count: 1
exec: true

variables:
  NODE_ENV: production
  STORAGE_TYPE: s3
  STORAGE_S3_REGION: ${AWS_REGION}
  IS_MULTIWORKSPACE_ENABLED: 'false'
  DISABLE_DB_MIGRATIONS: 'false'
  DISABLE_CRON_JOBS_REGISTRATION: 'false'
  PORT: '3000'
  SERVER_URL: 'https://${COPILOT_LB_DNS}'

secrets:
  PG_DATABASE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PG_DATABASE_URL
  REDIS_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/REDIS_URL
  APP_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/APP_SECRET

environments:
  production:
    count:
      range: 1-3
      cooldown:
        in: 60s
        out: 30s
      cpu_percentage: 70
